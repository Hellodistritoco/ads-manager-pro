<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes - ADS Manager Pro 3</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- DataTables CSS - CORREGIDO -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.10.1/sweetalert2.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.10.1/sweetalert2.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="../css/main.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --success-color: #059669;
            --warning-color: #d97706;
            --danger-color: #dc2626;
            --dark-color: #1e293b;
            --light-color: #f8fafc;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--light-color);
            color: var(--dark-color);
        }

        /* Sidebar styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--dark-color) 0%, #334155 100%);
            color: white;
            transition: transform 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .main-content {
            margin-left: var(--sidebar-width);
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        .sidebar-header {
            padding: 1.5rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-item {
            margin: 0.25rem 1rem;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .nav-link:hover, .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateX(4px);
        }

        .nav-link i {
            font-size: 1.1rem;
            width: 20px;
        }

        .top-bar {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .breadcrumb {
            background: none;
            margin: 0;
            padding: 0;
        }

        .breadcrumb-item {
            color: var(--secondary-color);
        }

        .breadcrumb-item.active {
            color: var(--dark-color);
            font-weight: 600;
        }

        /* Page specific styles */
        .page-header {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid #e2e8f0;
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--secondary-color);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .clients-table-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .table-header {
            background-color: #f8fafc;
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .search-box {
            position: relative;
            max-width: 300px;
            flex: 1;
        }

        .search-box input {
            padding-left: 2.5rem;
        }

        .search-box i {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-color);
        }

        .table {
            margin: 0;
        }

        .table th {
            border-top: none;
            font-weight: 600;
            color: var(--dark-color);
            background-color: #f8fafc;
            padding: 1rem;
        }

        .table td {
            padding: 1rem;
            vertical-align: middle;
        }

        .client-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .client-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .client-details h6 {
            margin: 0;
            font-weight: 600;
        }

        .client-details small {
            color: var(--secondary-color);
        }

        .badge {
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        /* Modal styles */
        .modal-header {
            background-color: var(--primary-color);
            color: white;
            border-bottom: none;
        }

        .modal-header .btn-close {
            filter: invert(1);
        }

        .form-floating label {
            color: var(--secondary-color);
        }

        .form-select, .form-control {
            border-radius: 8px;
            border: 1px solid #d1d5db;
        }

        .form-select:focus, .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.25);
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .sidebar.show {
                transform: translateX(0);
            }

            .stats-summary {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .page-header {
                padding: 1rem;
            }

            .table-header {
                flex-direction: column;
                align-items: stretch;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        /* Loading states */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--secondary-color);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h4 class="mb-0">
                <i class="bi bi-bullseye"></i> ADS Manager Pro 3
            </h4>
            <small class="text-muted">v3.0.0</small>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-item">
                <a href="dashboard.html" class="nav-link">
                    <i class="bi bi-speedometer2"></i>
                    <span>Dashboard</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="cliente.html" class="nav-link active">
                    <i class="bi bi-people"></i>
                    <span>Clientes</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="estrategia.html" class="nav-link">
                    <i class="bi bi-lightbulb"></i>
                    <span>Estrategias</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="metricas.html" class="nav-link">
                    <i class="bi bi-bar-chart"></i>
                    <span>Métricas</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="optimizacion.html" class="nav-link">
                    <i class="bi bi-gear"></i>
                    <span>Optimización</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="resultados.html" class="nav-link">
                    <i class="bi bi-file-earmark-text"></i>
                    <span>Resultados</span>
                </a>
            </div>
            
            <hr class="my-3 mx-3" style="border-color: rgba(255, 255, 255, 0.2);">
            
            <div class="nav-item">
                <a href="../index.html" class="nav-link">
                    <i class="bi bi-house"></i>
                    <span>Inicio</span>
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="d-flex align-items-center gap-3">
                <button class="btn btn-outline-secondary d-md-none" id="sidebarToggle">
                    <i class="bi bi-list"></i>
                </button>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></li>
                        <li class="breadcrumb-item active">Clientes</li>
                    </ol>
                </nav>
            </div>
            
            <div class="d-flex align-items-center gap-3">
                <button class="btn btn-outline-primary" onclick="refreshClients()">
                    <i class="bi bi-arrow-clockwise"></i> Actualizar
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#clientModal">
                    <i class="bi bi-person-plus"></i> Nuevo Cliente
                </button>
            </div>
        </div>

        <!-- Page Content -->
        <div class="container-fluid p-4">
            <!-- Page Header -->
            <div class="page-header">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h1 class="h3 mb-2">Gestión de Clientes</h1>
                        <p class="text-muted mb-0">Administra toda la información de tus clientes y sus campañas publicitarias</p>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">Total de clientes: <span id="totalClientsCount">--</span></small>
                    </div>
                </div>
            </div>

            <!-- Stats Summary -->
            <div class="stats-summary">
                <div class="stat-card">
                    <div class="stat-value" id="activeClientsCount">--</div>
                    <div class="stat-label">Clientes Activos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalRevenueCount">--</div>
                    <div class="stat-label">Ingresos Totales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgRoasCount">--</div>
                    <div class="stat-label">ROAS Promedio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeStrategiesCount">--</div>
                    <div class="stat-label">Estrategias Activas</div>
                </div>
            </div>

            <!-- Clients Table -->
            <div class="clients-table-card">
                <div class="table-header">
                    <h5 class="mb-0">Lista de Clientes</h5>
                    <div class="d-flex gap-3 align-items-center">
                        <div class="search-box">
                            <i class="bi bi-search"></i>
                            <input type="text" class="form-control" placeholder="Buscar clientes..." id="searchInput">
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="bi bi-funnel"></i> Filtrar
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="filterByStatus('all')">Todos</a></li>
                                <li><a class="dropdown-item" href="#" onclick="filterByStatus('active')">Activos</a></li>
                                <li><a class="dropdown-item" href="#" onclick="filterByStatus('inactive')">Inactivos</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="filterBySegment('e-commerce')">E-commerce</a></li>
                                <li><a class="dropdown-item" href="#" onclick="filterBySegment('servicios')">Servicios</a></li>
                                <li><a class="dropdown-item" href="#" onclick="filterBySegment('tecnologia')">Tecnología</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive" style="position: relative;">
                    <div class="loading-overlay d-none" id="tableLoading">
                        <div class="spinner"></div>
                    </div>
                    
                    <table class="table" id="clientsTable">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Email</th>
                                <th>Segmento</th>
                                <th>Presupuesto</th>
                                <th>ROAS</th>
                                <th>Estado</th>
                                <th>Fecha Registro</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody">
                            <!-- Content will be loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Client Modal -->
    <div class="modal fade" id="clientModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="clientModalTitle">Nuevo Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="clientForm">
                        <input type="hidden" id="clientId">
                        
                        <div class="row g-3">
                            <!-- Información Básica -->
                            <div class="col-12">
                                <h6 class="mb-3 text-primary">
                                    <i class="bi bi-person-circle"></i> Información Básica
                                </h6>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="nombre" required>
                                    <label for="nombre">Nombre del Cliente *</label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="empresa">
                                    <label for="empresa">Empresa</label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="email" class="form-control" id="email" required>
                                    <label for="email">Email *</label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="tel" class="form-control" id="telefono">
                                    <label for="telefono">Teléfono</label>
                                </div>
                            </div>

                            <!-- Segmentación -->
                            <div class="col-12 mt-4">
                                <h6 class="mb-3 text-primary">
                                    <i class="bi bi-tags"></i> Segmentación y Objetivos
                                </h6>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <select class="form-select" id="segmento" required>
                                        <option value="">Seleccionar segmento</option>
                                        <option value="e-commerce">E-commerce</option>
                                        <option value="servicios">Servicios</option>
                                        <option value="tecnologia">Tecnología</option>
                                        <option value="salud">Salud</option>
                                        <option value="educacion">Educación</option>
                                        <option value="inmobiliario">Inmobiliario</option>
                                        <option value="automotive">Automotriz</option>
                                        <option value="otros">Otros</option>
                                    </select>
                                    <label for="segmento">Segmento *</label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <select class="form-select" id="industria">
                                        <option value="">Seleccionar industria</option>
                                        <option value="retail">Retail</option>
                                        <option value="finanzas">Finanzas</option>
                                        <option value="tecnologia">Tecnología</option>
                                        <option value="salud">Salud</option>
                                        <option value="educacion">Educación</option>
                                        <option value="turismo">Turismo</option>
                                        <option value="inmobiliario">Inmobiliario</option>
                                        <option value="otros">Otros</option>
                                    </select>
                                    <label for="industria">Industria</label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <select class="form-select" id="tamanoEmpresa">
                                        <option value="">Seleccionar tamaño</option>
                                        <option value="startup">Startup (1-10 empleados)</option>
                                        <option value="pyme">PYME (11-50 empleados)</option>
                                        <option value="empresa">Empresa (51-200 empleados)</option>
                                        <option value="corporativo">Corporativo (200+ empleados)</option>
                                    </select>
                                    <label for="tamanoEmpresa">Tamaño de Empresa</label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="presupuestoMensual" step="0.01" min="0">
                                    <label for="presupuestoMensual">Presupuesto Mensual (USD)</label>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="form-floating">
                                    <textarea class="form-control" id="objetivoPrincipal" style="height: 100px"></textarea>
                                    <label for="objetivoPrincipal">Objetivo Principal</label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveClient()">
                        <i class="bi bi-check-circle"></i> Guardar Cliente
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery (required for DataTables) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- DataTables JS - CORREGIDO -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    
    <script>
        // Variables globales
        let clientsDataTable;
        let clientsData = [];
        let editingClientId = null;

        // API Client simplificado para este archivo
        const api = {
            baseUrl: '../api/',
            
            async getClientes() {
                try {
                    const response = await fetch(`${this.baseUrl}clientes`);
                    return await response.json();
                } catch (error) {
                    console.error('Error al obtener clientes:', error);
                    return { success: false, message: 'Error de conexión' };
                }
            },

            async getCliente(id) {
                try {
                    const response = await fetch(`${this.baseUrl}clientes/${id}`);
                    return await response.json();
                } catch (error) {
                    console.error('Error al obtener cliente:', error);
                    return { success: false, message: 'Error de conexión' };
                }
            },

            async createCliente(data) {
                try {
                    const response = await fetch(`${this.baseUrl}clientes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    return await response.json();
                } catch (error) {
                    console.error('Error al crear cliente:', error);
                    return { success: false, message: 'Error de conexión' };
                }
            },

            async updateCliente(id, data) {
                try {
                    const response = await fetch(`${this.baseUrl}clientes/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    return await response.json();
                } catch (error) {
                    console.error('Error al actualizar cliente:', error);
                    return { success: false, message: 'Error de conexión' };
                }
            }
        };

        // Validador simplificado
        function validateForm(form) {
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            return { isValid };
        }

        function enableRealTimeValidation(form, options = {}) {
            const inputs = form.querySelectorAll('input, select, textarea');
            
            inputs.forEach(input => {
                input.addEventListener('blur', () => validateForm(form));
                input.addEventListener('input', () => {
                    input.classList.remove('is-invalid');
                });
            });
        }

        // Inicializar página
        document.addEventListener('DOMContentLoaded', function() {
            initializeSidebar();
            loadClientsData();
            initializeSearch();
            setupFormValidation();
        });

        // Sidebar functionality
        function initializeSidebar() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');

            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('show');
                });
            }

            document.addEventListener('click', function(e) {
                if (window.innerWidth <= 768) {
                    if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
                        sidebar.classList.remove('show');
                    }
                }
            });
        }

        // Cargar datos de clientes usando la API
        async function loadClientsData() {
            try {
                showTableLoading(true);
                
                const response = await api.getClientes();
                
                if (response.success) {
                    clientsData = response.data;
                    updateStatsCards();
                    renderClientsTable();
                } else {
                    throw new Error(response.message);
                }
                
            } catch (error) {
                console.error('Error loading clients:', error);
                showError('Error al cargar los clientes');
                renderEmptyState();
            } finally {
                showTableLoading(false);
            }
        }

        // Actualizar tarjetas de estadísticas
        function updateStatsCards() {
            const activeClients = clientsData.filter(c => c.activo).length;
            const totalRevenue = clientsData.reduce((sum, c) => sum + (parseFloat(c.ingresos_total) || 0), 0);
            const avgRoas = clientsData.length > 0 ? 
                clientsData.reduce((sum, c) => sum + (parseFloat(c.roas_promedio) || 0), 0) / clientsData.length : 0;
            const activeStrategies = clientsData.reduce((sum, c) => sum + (parseInt(c.total_estrategias) || 0), 0);

            document.getElementById('totalClientsCount').textContent = clientsData.length;
            document.getElementById('activeClientsCount').textContent = activeClients;
            document.getElementById('totalRevenueCount').textContent = formatCurrency(totalRevenue);
            document.getElementById('avgRoasCount').textContent = formatNumber(avgRoas, 2) + 'x';
            document.getElementById('activeStrategiesCount').textContent = activeStrategies;
        }

        // Renderizar tabla de clientes
        function renderClientsTable() {
            const tbody = document.getElementById('clientsTableBody');
            
            if (clientsData.length === 0) {
                renderEmptyState();
                return;
            }
            
            tbody.innerHTML = clientsData.map(client => `
                <tr>
                    <td>
                        <div class="client-info">
                            <div class="client-avatar">
                                ${getClientInitials(client.nombre)}
                            </div>
                            <div class="client-details">
                                <h6>${client.nombre}</h6>
                                <small>${client.empresa || 'Sin empresa'}</small>
                            </div>
                        </div>
                    </td>
                    <td>${client.email}</td>
                    <td>
                        <span class="badge bg-primary">${client.segmento || 'N/A'}</span>
                    </td>
                    <td>${formatCurrency(client.presupuesto_mensual || 0)}</td>
                    <td>
                        <span class="fw-bold ${getRoasColor(client.roas_promedio || 0)}">
                            ${formatNumber(client.roas_promedio || 0, 2)}x
                        </span>
                    </td>
                    <td>
                        ${getStatusBadge(client.activo)}
                    </td>
                    <td>${formatDate(client.fecha_creacion)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewClient(${client.id})" title="Ver detalles">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="editClient(${client.id})" title="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="toggleClientStatus(${client.id})" title="${client.activo ? 'Desactivar' : 'Activar'}">
                                <i class="bi bi-${client.activo ? 'pause' : 'play'}"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Initialize DataTable if not already initialized
            if ($.fn.DataTable.isDataTable('#clientsTable')) {
                $('#clientsTable').DataTable().destroy();
            }

            clientsDataTable = $('#clientsTable').DataTable({
                pageLength: 10,
                responsive: true,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.10.21/i18n/Spanish.json'
                },
                columnDefs: [
                    { orderable: false, targets: [7] } // Disable sorting for actions column
                ]
            });
        }

        // Renderizar estado vacío
        function renderEmptyState() {
            const tbody = document.getElementById('clientsTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="8">
                        <div class="empty-state">
                            <i class="bi bi-people"></i>
                            <h5>No hay clientes registrados</h5>
                            <p>Comienza agregando tu primer cliente para gestionar sus campañas publicitarias</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#clientModal">
                                <i class="bi bi-person-plus"></i> Agregar Primer Cliente
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Inicializar búsqueda
        function initializeSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function() {
                if (clientsDataTable) {
                    clientsDataTable.search(this.value).draw();
                }
            });
        }

        // Configurar validación de formulario
        function setupFormValidation() {
            const form = document.getElementById('clientForm');
            enableRealTimeValidation(form, {
                validateOnBlur: true,
                clearOnInput: true,
                validateOnChange: true,
                showFormErrors: true
            });
        }

        // Guardar cliente usando la API
        async function saveClient() {
            try {
                const form = document.getElementById('clientForm');
                
                // Validar formulario usando el validador
                const validation = validateForm(form);
                if (!validation.isValid) {
                    return;
                }
                
                // Preparar datos
                const clientData = {
                    nombre: document.getElementById('nombre').value.trim(),
                    empresa: document.getElementById('empresa').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    telefono: document.getElementById('telefono').value.trim(),
                    segmento: document.getElementById('segmento').value,
                    industria: document.getElementById('industria').value,
                    tamano_empresa: document.getElementById('tamanoEmpresa').value,
                    presupuesto_mensual: parseFloat(document.getElementById('presupuestoMensual').value) || 0,
                    objetivo_principal: document.getElementById('objetivoPrincipal').value.trim()
                };
                
                // Mostrar loading
                const saveBtn = event.target;
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Guardando...';
                saveBtn.disabled = true;
                
                // API call usando el cliente API
                let result;
                if (editingClientId) {
                    result = await api.updateCliente(editingClientId, clientData);
                } else {
                    result = await api.createCliente(clientData);
                }
                
                if (result.success) {
                    // Success
                    Swal.fire({
                        icon: 'success',
                        title: editingClientId ? 'Cliente actualizado' : 'Cliente creado',
                        text: result.message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Close modal and reload data
                    bootstrap.Modal.getInstance(document.getElementById('clientModal')).hide();
                    loadClientsData();
                    resetForm();
                    
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                console.error('Error saving client:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Error al guardar el cliente'
                });
            } finally {
                // Restore button
                const saveBtn = document.querySelector('#clientModal .btn-primary');
                saveBtn.innerHTML = '<i class="bi bi-check-circle"></i> Guardar Cliente';
                saveBtn.disabled = false;
            }
        }

        // Ver detalles del cliente
        async function viewClient(clientId) {
            try {
                const result = await api.getCliente(clientId);
                
                if (result.success) {
                    const client = result.data;
                    
                    Swal.fire({
                        title: client.nombre,
                        html: `
                            <div class="text-start">
                                <p><strong>Empresa:</strong> ${client.empresa || 'N/A'}</p>
                                <p><strong>Email:</strong> ${client.email}</p>
                                <p><strong>Teléfono:</strong> ${client.telefono || 'N/A'}</p>
                                <p><strong>Segmento:</strong> ${client.segmento || 'N/A'}</p>
                                <p><strong>Industria:</strong> ${client.industria || 'N/A'}</p>
                                <p><strong>Presupuesto Mensual:</strong> ${formatCurrency(client.presupuesto_mensual || 0)}</p>
                                <p><strong>Objetivo:</strong> ${client.objetivo_principal || 'N/A'}</p>
                                <hr>
                                <h6>Estadísticas</h6>
                                <p><strong>Estrategias:</strong> ${client.estadisticas?.total_estrategias || 0}</p>
                                <p><strong>Inversión Total:</strong> ${formatCurrency(client.estadisticas?.inversion_total || 0)}</p>
                                <p><strong>ROAS Promedio:</strong> ${formatNumber(client.estadisticas?.roas_promedio || 0, 2)}x</p>
                            </div>
                        `,
                        width: 600,
                        showConfirmButton: false,
                        showCloseButton: true,
                        footer: `
                            <button class="btn btn-primary me-2" onclick="editClient(${clientId}); Swal.close();">
                                <i class="bi bi-pencil"></i> Editar
                            </button>
                            <a href="estrategia.html?cliente=${clientId}" class="btn btn-outline-primary">
                                <i class="bi bi-lightbulb"></i> Ver Estrategias
                            </a>
                        `
                    });
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                console.error('Error viewing client:', error);
                showError('Error al cargar los detalles del cliente');
            }
        }

        // Editar cliente
        async function editClient(clientId) {
            try {
                const result = await api.getCliente(clientId);
                
                if (result.success) {
                    const client = result.data;
                    
                    // Fill form with client data
                    document.getElementById('clientId').value = client.id;
                    document.getElementById('nombre').value = client.nombre || '';
                    document.getElementById('empresa').value = client.empresa || '';
                    document.getElementById('email').value = client.email || '';
                    document.getElementById('telefono').value = client.telefono || '';
                    document.getElementById('segmento').value = client.segmento || '';
                    document.getElementById('industria').value = client.industria || '';
                    document.getElementById('tamanoEmpresa').value = client.tamano_empresa || '';
                    document.getElementById('presupuestoMensual').value = client.presupuesto_mensual || '';
                    document.getElementById('objetivoPrincipal').value = client.objetivo_principal || '';
                    
                    // Update modal title
                    document.getElementById('clientModalTitle').textContent = 'Editar Cliente';
                    editingClientId = clientId;
                    
                    // Show modal
                    new bootstrap.Modal(document.getElementById('clientModal')).show();
                    
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                console.error('Error loading client for edit:', error);
                showError('Error al cargar los datos del cliente');
            }
        }

        // Cambiar estado del cliente
        async function toggleClientStatus(clientId) {
            try {
                const client = clientsData.find(c => c.id === clientId);
                if (!client) return;
                
                const action = client.activo ? 'desactivar' : 'activar';
                
                const result = await Swal.fire({
                    title: `¿${action.charAt(0).toUpperCase() + action.slice(1)} cliente?`,
                    text: `¿Estás seguro de que quieres ${action} este cliente?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: `Sí, ${action}`,
                    cancelButtonText: 'Cancelar'
                });
                
                if (result.isConfirmed) {
                    const updateResult = await api.updateCliente(clientId, {
                        activo: !client.activo
                    });
                    
                    if (updateResult.success) {
                        Swal.fire({
                            icon: 'success',
                            title: `Cliente ${action}o`,
                            timer: 2000,
                            showConfirmButton: false
                        });
                        
                        loadClientsData();
                    } else {
                        throw new Error(updateResult.message);
                    }
                }
                
            } catch (error) {
                console.error('Error toggling client status:', error);
                showError('Error al cambiar el estado del cliente');
            }
        }

        // Filtrar por estado
        function filterByStatus(status) {
            if (!clientsDataTable) return;
            
            let searchTerm = '';
            switch (status) {
                case 'active':
                    searchTerm = 'Activo';
                    break;
                case 'inactive':
                    searchTerm = 'Inactivo';
                    break;
                default:
                    searchTerm = '';
            }
            
            clientsDataTable.column(5).search(searchTerm).draw();
        }

        // Filtrar por segmento
        function filterBySegment(segment) {
            if (!clientsDataTable) return;
            
            clientsDataTable.column(2).search(segment === 'all' ? '' : segment).draw();
        }

        // Actualizar clientes
        function refreshClients() {
            loadClientsData();
        }

        // Reset form
        function resetForm() {
            document.getElementById('clientForm').reset();
            document.getElementById('clientId').value = '';
            document.getElementById('clientModalTitle').textContent = 'Nuevo Cliente';
            editingClientId = null;
            
            // Clear validation errors
            document.querySelectorAll('.is-invalid').forEach(field => {
                field.classList.remove('is-invalid');
            });
            document.querySelectorAll('.invalid-feedback').forEach(feedback => {
                feedback.remove();
            });
        }

        // Event listener for modal reset
        document.getElementById('clientModal').addEventListener('hidden.bs.modal', resetForm);

        // Utility functions
        function showTableLoading(show) {
            const loading = document.getElementById('tableLoading');
            if (show) {
                loading.classList.remove('d-none');
            } else {
                loading.classList.add('d-none');
            }
        }

        function showError(message) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: message
            });
        }

        function getClientInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        function getStatusBadge(active) {
            return active ? 
                '<span class="badge bg-success">Activo</span>' : 
                '<span class="badge bg-secondary">Inactivo</span>';
        }

        function getRoasColor(roas) {
            if (roas >= 4) return 'text-success';
            if (roas >= 2) return 'text-primary';
            if (roas >= 1) return 'text-warning';
            return 'text-danger';
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatNumber(number, decimals = 0) {
            return new Intl.NumberFormat('es-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(number);
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
    </script>
</body>
</html>